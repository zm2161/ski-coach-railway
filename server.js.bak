require('dotenv').config();
const express = require('express');
const multer = require('multer');
const ffmpeg = require('fluent-ffmpeg');
const { GoogleGenerativeAI } = require('@google/generative-ai');
const path = require('path');
const fs = require('fs');
const { v4: uuidv4 } = require('uuid');

const app = express();
const PORT = process.env.PORT || 3000;

// 初始化 Gemini AI
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// 确保上传目录存在
const uploadsDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadsDir)) {
  fs.mkdirSync(uploadsDir, { recursive: true });
}

// 配置 Multer
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, uploadsDir);
  },
  filename: (req, file, cb) => {
    const videoId = uuidv4();
    const ext = path.extname(file.originalname);
    cb(null, `${videoId}${ext}`);
  }
});

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 100 * 1024 * 1024 // 100MB
  },
  fileFilter: (req, file, cb) => {
    const allowedTypes = ['.mp4', '.mov', '.avi', '.webm'];
    const ext = path.extname(file.originalname).toLowerCase();
    if (allowedTypes.includes(ext)) {
      cb(null, true);
    } else {
      cb(new Error('不支持的文件格式。仅支持 MP4, MOV, AVI, WEBM'));
    }
  }
});

// 中间件
app.use(express.json());
app.use(express.static('public'));
app.use('/uploads', express.static('uploads'));

// 获取视频元数据
function getVideoMetadata(videoPath) {
  return new Promise((resolve, reject) => {
    ffmpeg.ffprobe(videoPath, (err, metadata) => {
      if (err) {
        reject(err);
      } else {
        // 解析帧率 (格式: "30/1" 或 "30000/1001")
        let fps = 30;
        if (metadata.streams[0].r_frame_rate) {
          const [num, den] = metadata.streams[0].r_frame_rate.split('/').map(Number);
          if (den && den > 0) {
            fps = num / den;
          }
        }
        resolve({
          duration: metadata.format.duration,
          fps: fps
        });
      }
    });
  });
}

// 检测视频中的运动变化点（简化版：均匀分割）
function detectMotionChanges(duration, segmentCount = 5) {
  const segments = [];
  const segmentDuration = duration / segmentCount;
  
  for (let i = 0; i < segmentCount; i++) {
    const freezeAt = i * segmentDuration + segmentDuration / 2;
    segments.push({
      id: i + 1,
      freeze_at: Math.round(freezeAt * 10) / 10 // 保留一位小数
    });
  }
  
  return segments;
}

// 提取关键帧（用于AI分析）
function extractKeyFrame(videoPath, timestamp, outputPath) {
  return new Promise((resolve, reject) => {
    ffmpeg(videoPath)
      .seekInput(timestamp)
      .frames(1)
      .output(outputPath)
      .on('end', () => resolve())
      .on('error', (err) => reject(err))
      .run();
  });
}

// 获取地形上下文
function getTerrainContext(terrain) {
  const terrainContexts = {
    'beginner': '平地/绿道（初级）',
    'intermediate': '蓝道（中级）',
    'advanced': '黑道（高级陡坡）',
    'moguls': '蘑菇道（雪包）',
    'freestyle': '自由式（公园、跳台）'
  };
  
  const terrainDescriptions = {
    'beginner': '初学者地形，重点关注基础姿势和平衡',
    'intermediate': '中级地形，需要连贯的转弯节奏和刃角控制',
    'advanced': '高级陡坡，强调快速刃角转换和重心前移',
    'moguls': '雪包地形，需要快速的膝盖收展和上下起伏',
    'freestyle': '公园地形，关注起跳姿态、空中平衡和落地缓冲'
  };
  
  return terrainDescriptions[terrain] || terrainContexts[terrain] || terrain;
}

// 根据片段编号获取重点关注的方面（轮换重点，避免重复）
function getSegmentFocus(segmentNumber, sport) {
  if (sport === 'skiing') {
    const focuses = [
      '**片段1重点**：下肢关节链 - 脚踝背屈、膝盖屈曲与角化、髋部折叠',
      '**片段2重点**：重心位置 - 躯干前倾/后仰、前后脚配重、板头板尾压力分布',
      '**片段3重点**：上半身姿态 - 肩膀朝向、手臂位置、上身稳定性',
      '**片段4重点**：雪板工作状态 - 刃角大小、切雪效果、板间距',
      '**片段5重点**：运动链完整性 - 关节配合节奏、力量传递路径、动作时机'
    ];
    return focuses[(segmentNumber - 1) % focuses.length];
  } else {
    const focuses = [
      '**片段1重点**：下肢关节链 - 脚踝外翻、膝盖外开（最关键！）、髋部旋转',
      '**片段2重点**：重心与扭转 - 躯干前倾/侧倾、肩膀旋转、上下身扭转',
      '**片段3重点**：手臂与平衡 - 前手指向、后手打开、平衡控制',
      '**片段4重点**：雪板工作状态 - 刃角大小、前后脚配重、板头板尾独立控制',
      '**片段5重点**：运动链完整性 - 三维空间配合、力量传递、动作流畅性'
    ];
    return focuses[(segmentNumber - 1) % focuses.length];
  }
}

// 双板滑雪分析要点常量
const SKIING_ANALYSIS_POINTS = `
## 双板滑雪观察要点（按运动链原理分析）

### 1. 下肢关节链（最关键）

**脚踝 → 膝盖 → 髋部的协同工作**

**脚踝（踝关节背屈）**：
- 观察：小腿是否像推门一样向前压，紧贴雪鞋前壳？
- 原理：脚踝背屈将你的重量传递到板头，就像杠杆的支点前移，板头才能咬住雪
- 感受指标：能否感到胫骨前肌（小腿正前方）持续发力，像在用小腿推墙？
- 常见错误：脚踝僵直 → 重心像被拉回椅子上 → 板尾打滑失控

**膝盖（膝关节屈曲与内扣）**：
- 观察：膝盖是否像弹簧一样压缩，同时向弯内侧倾斜（不是向内夹！）
- 姿态比喻：想象坐在一张隐形的高脚凳上，大腿与小腿形成明显夹角
- 原理：膝盖向弯内推产生"膝关节角化"，就像用刀刃切蛋糕 —— 膝盖推出去，雪板才能立起刃来
- 力学链条：膝盖向弯内推 → 小腿外侧受压 → 雪板外刃吃劲 → 产生向心力抓住雪面
- 感受指标：大腿前侧（股四头肌）持续发力，膝盖始终在脚尖正上方或略偏弯内
- 常见错误：膝盖僵直 → 像站在木桩上 → 无法产生刃角 → 雪板平拍雪面侧滑

**髋部（髋关节屈曲与反向角化）**：
- 观察：髋部是否像门铰链一样折叠，上身前倾的同时髋部保持相对水平？
- 姿态比喻：像在鞠躬，但只弯髋部不弯腰，屁股略微向后撅
- 原理：髋部反向角化让上身保持稳定朝向下山，而让腿部自由地完成转弯动作
- 对比：正确的是"髋部折叠+腿部倾斜"，错误的是"整个身体像木板一样倾倒"
- 力学：髋部稳定 → 上半身质量集中 → 重心在脚掌上方 → 平衡稳如泰山
- 感受指标：髋屈肌（腹股沟位置）有拉伸感，能感觉到上下身分离工作
- 常见错误：髋部不屈 → 上身直立僵硬 → A字架姿势 → 失去刃角控制

### 2. 上半身姿态与配重

**躯干倾斜（前后向）**：
- 观察：鼻子是否在雪鞋扣正上方？还是落在后面？
- 姿态比喻：像要闻前脚上的雪味儿，身体自然前倾
- 原理：前倾将你的体重投射到支撑面前部，像按压跷跷板的前端，板头才有力量
- 力学：质心前移 → 板头压雪 → 板头咬雪 → 转弯启动干脆利落
- 感受指标：感觉前脚掌承担主要重量，小腿胫骨持续顶住雪鞋前壳
- 常见错误：后仰 → 像坐在椅子上 → 板尾承重 → 失去转向控制

**肩膀朝向（旋转轴）**：
- 观察：肩线是否像罗盘指针，始终指向山下（平行于雪道边缘）？
- 姿态比喻：肩膀像稳定器，固定上身的参考系
- 原理：肩膀固定朝向山下 → 髋部相对肩膀自由旋转 → 腿部独立完成转弯
- 运动链：肩膀不动 → 髋部可以自由转 → 腿有空间完成动作
- 感受指标：两肩连线始终能看到下方的雪道，不随转弯过度旋转
- 常见错误：肩膀跟着雪板旋转 → 髋部被迫跟随 → 腿失去独立性 → 动作僵硬

**手臂位置（平衡杆与节奏器）**：
- 观察：双手是否像端着方向盘一样在身前？还是像企鹅一样贴在身侧？
- 姿态比喻：想象端着一个大托盘，肘部自然弯曲
- 原理：手臂前伸增加旋转惯量，像花样滑冰运动员张开手臂保持平衡
- 力学：双臂前伸 → 身体转动惯量增大 → 上身更难被扰动 → 平衡如钟摆
- 感受指标：手腕与髋部差不多高，在余光边缘能看到双手
- 常见错误：手臂后拉 → 像被人拽住 → 重心后移 → 板尾过载

### 3. 雪板工作状态（结果验证）

**刃角（Edge Angle）**：
- 观察：雪板与雪面的夹角够不够大？能否看到明显的板底？
- 视觉比喻：像用刀切面包 —— 刃角越大，切得越深，抓地力越强
- 原理：刃角产生垂直于雪面的压力分量，创造横向摩擦力
- 验证方法：能否看到板底？能看到说明刃角足够；有没有清脆的"呲呲"切雪声？雪花是否从板刃下方均匀喷出？

**压力分布（前后配重）**：
- 观察：雪印前段是否比后段更深？
- 理想状态：前脚像主驾驶，承担主要工作；后脚像副驾驶，辅助稳定
- 原理：前压驱动板头入雪启动转弯，后压稳定板尾完成转弯
- 验证方法：雪印前半段更深，板头有明显雪花喷溅；前脚掌持续有压力感；转弯启动利落不拖泥带水

**板间距与独立性**：
- 观察：两板距离大约是髋宽，保持平行还是一宽一窄？
- 姿态比喻：像火车轨道，两条轨迹平行前进
- 原理：保持板间独立运动空间，外板承担主要压力，内板轻盈辅助
- 验证方法：雪印中外板（弯外侧那只板）的轨迹更深；外腿持续发力，内腿相对轻松

### 4. 运动链完整性检查（必须分析）

**动作序列的因果关系**：
- 从下到上：脚踝启动 → 膝盖跟随 → 髋部协调 → 躯干稳定 → 肩膀指引
- 从上到下：肩膀指向目标 → 髋部旋转跟随 → 膝盖角化执行 → 脚踝传递力量
- 原理：运动是运动链协同工作的结果，像传送带一样环环相扣，不是某个关节单打独斗
- 比喻：就像推倒多米诺骨牌，一个动作触发下一个，形成流畅的连锁反应
- 检查：如果某个环节有问题，往往是上游环节没做对导致的

**力量传递路径**：
- 重力路径：你的体重 → 通过脚踝传到雪板 → 雪板压雪面 → 雪面反推你 → 产生向心力
- 主动发力：肌肉收缩 → 改变关节角度 → 雪板姿态变化 → 滑行轨迹改变
- 比喻：力量像水流，要沿着最优路径流动，不能在中间"漏水"或"堵塞"
- 检查：力量有没有在某个关节"泄掉"？比如膝盖内夹就是力量泄漏

**时机与节奏**：
- 动作启动时机：是不是该转弯时才开始转？还是提前或滞后了？
- 关节配合节奏：各个关节是否按正确顺序依次启动？还是同时僵硬地一起动？
- 比喻：像乐队演奏，每个乐器要在正确的节拍上加入，太早太晚都不和谐
- 检查：转弯启动是否在合适的时机？动作是否流畅如行云流水？
`;

// 单板滑雪分析要点常量
const SNOWBOARDING_ANALYSIS_POINTS = `
## 单板滑雪观察要点（按力学原理分析）

### 1. 下肢关节链（最关键）

**单板特殊性：侧向站位，需要三维空间的扭转和倾斜配合**

**脚踝（背屈与外翻）**：
- 观察：小腿是否像推门一样向前压？同时脚踝向板外侧推（不是向内收！）
- 姿态比喻：想象脚踝像铰链，既向前开又向外开
- 原理：脚踝外翻将膝盖推向板外侧，就像推倒多米诺骨牌的第一张牌，启动整个刃角链条
- 力学链条：脚踝外翻 → 小腿向外倾 → 雪板外刃增压 → 刃角产生
- 感受指标：小腿外侧肌肉（腓骨长肌）持续发力，像在用小腿外侧推墙
- 常见错误：脚踝内收 → 膝盖被迫向内夹 → 刃角消失 → 像溜冰鞋打滑一样侧滑失控

**膝盖（屈曲与外开 —— 最关键！）**：
- 观察：膝盖是否像弹簧一样压缩？更重要的是，是否向板外侧推开？
- 姿态比喻：错误的像 X 型腿，膝盖向内夹（大忌！）；正确的像骑马蹲，膝盖向外推开
- 关键动作：膝盖必须向板外侧推（外展），绝不能向内夹！
- 原理深度解析：膝盖向外推 = 产生刃角的主要来源。就像用刀切菜 —— 不是把刀平放（膝盖内夹），而是立起刀刃（膝盖外开）
- 三维空间运动：
  * 顺板方向：前膝比后膝弯得更深 → 重心前移 → 板头有控制权
  * 垂直方向：双膝同时下压 → 像坐下去 → 重心降低 → 更稳定
  * 横向方向：膝盖向外推 → 像膝盖要碰到雪面外侧 → 产生刃角 → 转弯力量来源
- 力学原理：膝盖外开 → 小腿向板边倾斜 → 雪板立起刃角 → 刃咬住雪；膝盖下压 → 垂直压力增加 → 刃切入雪面更深 → 抓地力增强
- 检查方法：从正面看，膝盖应该超出脚尖外侧，不是在脚尖内侧！从侧面看，前膝明显比后膝弯得更深，像弓步
- 感受指标：大腿外侧（髂胫束）像拉紧的绳子，持续紧绷；大腿前侧（股四头肌）持续发力，像深蹲的感觉；能感觉板刃像刀一样"咬住"雪面，有明确的抓地感
- 常见错误分析：膝盖向内夹 → 像关门而不是开门 → 刃角消失 → 雪板平躺在雪面 → 像溜冰打滑

**髋部（屈曲、旋转与角化）**：
- 观察：髋部是否像旋转门一样灵活转动？同时保持适当的前倾？
- 姿态比喻：屈曲像要坐在高脚凳上，屁股向后撅；旋转像转身看后面的人，髋部先转；角化：髋部向弯内移动，但不要倒下去
- 原理：髋部是单板控制的指挥中心，三个维度的运动缺一不可
- 运动链：髋部旋转 → 像传动轴一样带动大腿 → 雪板跟着转 → 膝盖角化产生刃角
- 感受指标：屈曲时髋屈肌（腹股沟）有拉伸感；旋转时髋部在前脚正上方，不是在两脚中间；角化时能感觉髋部向弯内推，但头还在雪板上方
- 常见错误：髋部不旋转 → 像机器人转身 → 只靠肩膀转 → 上下身打架 → 失控

### 2. 上半身姿态与扭转

**躯干前倾与侧倾（双平面姿态）**：
- 观察：鼻子是否在前脚绑定上方？身体有没有像树一样倒向弯内侧？
- 姿态比喻：前倾像要闻前脚的气味；侧倾像在抵抗侧风，但不要倒下去
- 原理：前倾质心前移 → 前脚承重 → 板头听你指挥；侧倾配合下肢角化 → 增加一点刃角 → 但主要靠膝盖，不是靠躯干倒
- 关键：前倾是主角，侧倾是配角（千万别本末倒置！）
- 感受指标：前倾时感觉前脚掌承担主要重量；侧倾时头部还在雪板上方，没有伸到板外侧去
- 常见错误：过度侧倾 → 像树倒了 → 质心跑到支撑面外 → 直接摔倒

**肩膀旋转（上身扭转控制）**：
- 观察：前手是否指向下一个转弯的出口？肩膀比髋部转得少？
- 姿态比喻：像拧毛巾 —— 肩膀和髋部反向拧紧，然后释放
- 理想状态：肩膀朝向下一个转弯出口，髋部还在完成上一个转弯
- 原理：上下身反向扭转储存弹性能量，就像压缩弹簧，释放时转弯爆发力强
- 运动链：肩膀先转向出口 → 躯干扭转 → 像拧紧发条；髋部跟随旋转 → 释放扭转能量 → 雪板快速转向
- 感受指标：能感觉到腰腹部有扭转张力；后肩能看到后手，说明扭转充分
- 常见错误：肩髋同步转 → 没有扭转 → 没有预加载 → 转弯慢吞吞

**手臂位置（平衡与方向指示）**：
- 观察：前手是否像指路牌一样指向你要去的地方？后手打开帮助平衡？
- 姿态比喻：前手像指挥棒，指哪打哪；后手像飞机机翼，打开保持平衡
- 原理：前手指向：眼睛跟随手指 → 肩膀跟随视线 → 全身协调转向；双臂打开：增加旋转惯量 → 像花样滑冰张开手臂 → 上身更稳定
- 感受指标：前手始终指向你想去的方向，像车灯照向前方
- 常见错误：双手下垂或贴身 → 像企鹅 → 失去平衡功能 → 容易被颠簸扰动

### 3. 雪板工作状态（结果验证）

**刃角（Edge Angle）**：
- 观察：能否看到整块板底？看到的面积越大说明刃角越大
- 视觉比喻：像用刀切西瓜 —— 刀立得越直（刃角越大），切得越深
- 原理：单板单刃承重，需要更大刃角才能产生足够的向心力不被甩出去
- 验证方法：刃角够大的话，能看到大部分板底；应该听到尖锐的"呲呲"切雪声，不是"沙沙"侧滑声；雪花从板刃一侧高速喷出，形成漂亮的"公鸡尾"

**压力分布（前后脚配重）**：
- 观察：雪印前段是否明显更深？
- 理想比喻：前脚像船长掌舵，后脚像水手辅助
- 原理：前脚主导控制板头方向，后脚稳定板尾防止甩尾
- 动态变化：转弯启动时前脚压得更重 → 板头快速切入弯内 → 像船头劈波斩浪
- 感受指标：前脚掌持续有明显压力感，像踩油门
- 验证方法：雪印前段深，后段浅；转弯启动干脆利落，不拖泥带水

**板头板尾独立控制**：
- 观察：能否感觉到前后脚独立发力？不是一起用力？
- 原理：单板虽然是一整块板，但通过压力分配实现"虚拟分段"
- 比喻：板头控制：前脚下压 → 像踩跷跷板的一端 → 板头插入雪面 → 启动转弯；板尾控制：后脚下压 → 稳定后端 → 完成转弯不甩尾
- 感受指标：能清楚感觉到前后脚分工明确，不是同时均匀用力

### 4. 运动链完整性检查（必须分析）

**动作序列的因果关系**：
- 从下到上：脚踝启动 → 膝盖跟随 → 髋部协调 → 躯干稳定 → 肩膀指引
- 从上到下：肩膀指向目标 → 髋部旋转跟随 → 膝盖角化执行 → 脚踝传递力量
- 原理：运动是运动链协同工作的结果，像传送带一样环环相扣，不是某个关节单打独斗
- 比喻：就像推倒多米诺骨牌，一个动作触发下一个，形成流畅的连锁反应
- 检查：如果某个环节有问题，往往是上游环节没做对导致的

**力量传递路径**：
- 重力路径：你的体重 → 通过脚踝传到雪板 → 雪板压雪面 → 雪面反推你 → 产生向心力
- 主动发力：肌肉收缩 → 改变关节角度 → 雪板姿态变化 → 滑行轨迹改变
- 比喻：力量像水流，要沿着最优路径流动，不能在中间"漏水"或"堵塞"
- 检查：力量有没有在某个关节"泄掉"？比如膝盖内夹就是力量泄漏

**时机与节奏**：
- 动作启动时机：是不是该转弯时才开始转？还是提前或滞后了？
- 关节配合节奏：各个关节是否按正确顺序依次启动？还是同时僵硬地一起动？
- 比喻：像乐队演奏，每个乐器要在正确的节拍上加入，太早太晚都不和谐
- 检查：转弯启动是否在合适的时机？动作是否流畅如行云流水？
`;

// 生成片段分析 Prompt
function generateSegmentPrompt(sport, terrain, segmentNumber, totalSegments) {
  const sportFramework = sport === 'skiing' 
    ? 'CSIA 双板滑雪教学标准' 
    : 'CASI 单板滑雪教学标准';
  
  const terrainContext = getTerrainContext(terrain);
  
  const terrainMap = {
    'beginner': '平地/绿道（初级）',
    'intermediate': '蓝道（中级）',
    'advanced': '黑道（高级陡坡）',
    'moguls': '蘑菇道（雪包）',
    'freestyle': '自由式（公园、跳台）'
  };
  
  return `
【分析任务】

你正在分析${sportFramework}下的第 ${segmentNumber}/${totalSegments} 个动作片段。

【地形】${terrainMap[terrain] || terrain} - ${terrainContext}

⚠️ **重要**：

1. 这是一个视频的第 ${segmentNumber} 个关键帧，**仔细观察图片中滑雪者的具体姿态**

2. 每个片段关注的问题应该**不同** - 不要重复分析相同的问题

3. 根据图片中的**实际动作**找出最突出的1-2个问题，而不是套用模板

【本片段应优先关注】（按片段顺序轮换重点）：

${getSegmentFocus(segmentNumber, sport)}

---

${sport === 'skiing' ? SKIING_ANALYSIS_POINTS : SNOWBOARDING_ANALYSIS_POINTS}

---

## 分析输出要求

### 标题格式（5-7 个汉字）

- **必须根据图片中观察到的实际问题命名**

- 不同片段应该有不同的标题

- 例如：
  * 片段1可能是 "膝盖过直" 
  * 片段2可能是 "重心太靠后"
  * 片段3可能是 "肩膀逆转"
  * 片段4可能是 "手臂位置低"
  * 片段5可能是 "压刃不足"

### 分析内容（5句话强制结构）

**第一句 - 问题识别**：

- **观察图片**：描述你在图片中看到的具体姿态

- 格式：[关节/部位] + [具体偏差] + [生动比喻]

- ✅ 例如："你的膝盖几乎是直的，像站在木桩上，而不是像弹簧那样压缩"

- ✅ 例如："你的上身后仰，鼻子在脚后跟上方，像坐在椅子上"

- ✅ 例如："你的双手垂在身侧，像企鹅一样，而不是像端方向盘"

- ❌ 避免：每个片段都说"膝盖内夹"

**第二句 - 生物力学原理**：

- 解释这个**具体问题**的力学后果

- ✅ 例如（针对膝盖直）："膝盖僵直像一根木棍，无法通过弯曲产生刃角，力量直上直下传递，雪板无法立起切入雪面，只能平拍雪面侧滑"

- ✅ 例如（针对重心后）："重心后移让板尾承受主要压力，就像跷跷板的后端被压下，板头翘起失去控制，转弯启动迟缓"

**第三句 - 具体改进方法**：

- 针对**这个具体问题**的解决方案

- ✅ 例如（针对膝盖直）："下一个转弯开始前，想象坐在隐形的高脚凳上，膝盖向前推压，感觉大腿前侧发力"

- ✅ 例如（针对重心后）："进入转弯前，想象要闻前脚上的雪味，鼻子前移到前脚扣上方，感觉小腿压紧雪鞋前壳"

**第四句 - 验证方法**：

- 说明改正**这个问题**后应有的感受

- 使用感官反馈（触觉、视觉、听觉）

**第五句 - 简短鼓励**：

- 指出**其他方面**做得好的地方（不是问题点）

- ✅ 例如："你的肩膀朝向很稳定，配合膝盖动作就完美了！"

- ✅ 例如："你的转弯节奏感很好，改善重心位置后会有质的飞跃。"

---

## ⚠️ 重要提醒

1. **不要套用模板** - 每个片段的问题应该根据图片实际观察到的姿态来分析

2. **避免重复** - 如果前面的片段已经指出了"膝盖内夹"，后面的片段应该关注其他问题

3. **真实观察** - 仔细看图片中的：
   - 膝盖角度（弯曲程度、内外倾向）
   - 上身倾斜（前倾、后仰、侧倾）
   - 手臂位置（高低、前后）
   - 肩膀方向（朝向山下还是旋转）
   - 雪板状态（刃角、平拍）

---

**仔细观察图片**，分析这个动作片段中最突出的问题。

请以JSON格式返回：
{
  "title": "标题（5-7个汉字）",
  "text": "第一句问题识别。第二句生物力学原理。第三句具体改进方法。第四句验证方法。第五句简短鼓励。"
}`;
}

// 调用 Gemini API 生成教练反馈（带重试机制）
async function generateCoachingFeedback(sport, terrain, segmentNumber, totalSegments, retries = 3) {
  // 使用新的 generateSegmentPrompt 函数生成 prompt
  const prompt = generateSegmentPrompt(sport, terrain, segmentNumber, totalSegments);
  
  for (let i = 0; i < retries; i++) {
    try {
      const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });
      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();
      
      // 尝试解析JSON（可能包含markdown代码块）
      let jsonText = text.trim();
      if (jsonText.startsWith('```json')) {
        jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      } else if (jsonText.startsWith('```')) {
        jsonText = jsonText.replace(/```\n?/g, '').trim();
      }
      
      const coaching = JSON.parse(jsonText);
      return coaching;
    } catch (error) {
      console.error(`Gemini API 调用失败 (尝试 ${i + 1}/${retries}):`, error.message);
      if (i === retries - 1) {
        // 最后一次失败，返回默认反馈
        return {
          title: `片段 ${segmentNumber} 分析`,
          text: `这是第${segmentNumber}个视频片段。由于AI分析暂时不可用，请继续观看视频，注意保持平衡和正确的姿势。`
        };
      }
      // 等待后重试
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}

// 生成练习推荐
async function generateRecommendations(sport, terrain, allSegments, retries = 3) {
  const framework = sport === 'skiing' ? 'CSIA' : 'CASI';
  const sportName = sport === 'skiing' ? '双板滑雪' : '单板滑雪';
  
  const terrainMap = {
- 常见错误：脚踝僵直 → 重心像被拉回椅子上 → 板尾打滑失控

**膝盖（膝关节屈曲与内扣）**：
- 观察：膝盖是否像弹簧一样压缩，同时向弯内侧倾斜（不是向内夹！）
- 姿态比喻：想象坐在一张隐形的高脚凳上，大腿与小腿形成明显夹角
- 原理：膝盖向弯内推产生"膝关节角化"，就像用刀刃切蛋糕 —— 膝盖推出去，雪板才能立起刃来
- 力学链条：膝盖向弯内推 → 小腿外侧受压 → 雪板外刃吃劲 → 产生向心力抓住雪面
- 感受指标：大腿前侧（股四头肌）持续发力，膝盖始终在脚尖正上方或略偏弯内
- 常见错误：膝盖僵直 → 像站在木桩上 → 无法产生刃角 → 雪板平拍雪面侧滑

**髋部（髋关节屈曲与反向角化）**：
- 观察：髋部是否像门铰链一样折叠，上身前倾的同时髋部保持相对水平？
- 姿态比喻：像在鞠躬，但只弯髋部不弯腰，屁股略微向后撅
- 原理：髋部反向角化让上身保持稳定朝向下山，而让腿部自由地完成转弯动作
- 对比：正确的是"髋部折叠+腿部倾斜"，错误的是"整个身体像木板一样倾倒"
- 力学：髋部稳定 → 上半身质量集中 → 重心在脚掌上方 → 平衡稳如泰山
- 感受指标：髋屈肌（腹股沟位置）有拉伸感，能感觉到上下身分离工作
- 常见错误：髋部不屈 → 上身直立僵硬 → A字架姿势 → 失去刃角控制

### 2. 上半身姿态与配重

**躯干倾斜（前后向）**：
- 观察：鼻子是否在雪鞋扣正上方？还是落在后面？
- 姿态比喻：像要闻前脚上的雪味儿，身体自然前倾
- 原理：前倾将你的体重投射到支撑面前部，像按压跷跷板的前端，板头才有力量
- 力学：质心前移 → 板头压雪 → 板头咬雪 → 转弯启动干脆利落
- 感受指标：感觉前脚掌承担主要重量，小腿胫骨持续顶住雪鞋前壳
- 常见错误：后仰 → 像坐在椅子上 → 板尾承重 → 失去转向控制

**肩膀朝向（旋转轴）**：
- 观察：肩线是否像罗盘指针，始终指向山下（平行于雪道边缘）？
- 姿态比喻：肩膀像稳定器，固定上身的参考系
- 原理：肩膀固定朝向山下 → 髋部相对肩膀自由旋转 → 腿部独立完成转弯
- 运动链：肩膀不动 → 髋部可以自由转 → 腿有空间完成动作
- 感受指标：两肩连线始终能看到下方的雪道，不随转弯过度旋转
- 常见错误：肩膀跟着雪板旋转 → 髋部被迫跟随 → 腿失去独立性 → 动作僵硬

**手臂位置（平衡杆与节奏器）**：
- 观察：双手是否像端着方向盘一样在身前？还是像企鹅一样贴在身侧？
- 姿态比喻：想象端着一个大托盘，肘部自然弯曲
- 原理：手臂前伸增加旋转惯量，像花样滑冰运动员张开手臂保持平衡
- 力学：双臂前伸 → 身体转动惯量增大 → 上身更难被扰动 → 平衡如钟摆
- 感受指标：手腕与髋部差不多高，在余光边缘能看到双手
- 常见错误：手臂后拉 → 像被人拽住 → 重心后移 → 板尾过载

### 3. 雪板工作状态（结果验证）

**刃角（Edge Angle）**：
- 观察：雪板与雪面的夹角够不够大？能否看到明显的板底？
- 视觉比喻：像用刀切面包 —— 刃角越大，切得越深，抓地力越强
- 原理：刃角产生垂直于雪面的压力分量，创造横向摩擦力
- 验证方法：能否看到板底？能看到说明刃角足够；有没有清脆的"呲呲"切雪声？雪花是否从板刃下方均匀喷出？

**压力分布（前后配重）**：
- 观察：雪印前段是否比后段更深？
- 理想状态：前脚像主驾驶，承担主要工作；后脚像副驾驶，辅助稳定
- 原理：前压驱动板头入雪启动转弯，后压稳定板尾完成转弯
- 验证方法：雪印前半段更深，板头有明显雪花喷溅；前脚掌持续有压力感；转弯启动利落不拖泥带水

**板间距与独立性**：
- 观察：两板距离大约是髋宽，保持平行还是一宽一窄？
- 姿态比喻：像火车轨道，两条轨迹平行前进
- 原理：保持板间独立运动空间，外板承担主要压力，内板轻盈辅助
- 验证方法：雪印中外板（弯外侧那只板）的轨迹更深；外腿持续发力，内腿相对轻松
`;

  const snowboardingAnalysisGuide = `
## 单板滑雪观察要点（按力学原理分析）

### 1. 下肢关节链（最关键）

**单板特殊性：侧向站位，需要三维空间的扭转和倾斜配合**

**脚踝（背屈与外翻）**：
- 观察：小腿是否像推门一样向前压？同时脚踝向板外侧推（不是向内收！）
- 姿态比喻：想象脚踝像铰链，既向前开又向外开
- 原理：脚踝外翻将膝盖推向板外侧，就像推倒多米诺骨牌的第一张牌，启动整个刃角链条
- 力学链条：脚踝外翻 → 小腿向外倾 → 雪板外刃增压 → 刃角产生
- 感受指标：小腿外侧肌肉（腓骨长肌）持续发力，像在用小腿外侧推墙
- 常见错误：脚踝内收 → 膝盖被迫向内夹 → 刃角消失 → 像溜冰鞋打滑一样侧滑失控

**膝盖（屈曲与外开 —— 最关键！）**：
- 观察：膝盖是否像弹簧一样压缩？更重要的是，是否向板外侧推开？
- 姿态比喻：错误的像 X 型腿，膝盖向内夹（大忌！）；正确的像骑马蹲，膝盖向外推开
- 关键动作：膝盖必须向板外侧推（外展），绝不能向内夹！
- 原理深度解析：膝盖向外推 = 产生刃角的主要来源。就像用刀切菜 —— 不是把刀平放（膝盖内夹），而是立起刀刃（膝盖外开）
- 三维空间运动：
  * 顺板方向：前膝比后膝弯得更深 → 重心前移 → 板头有控制权
  * 垂直方向：双膝同时下压 → 像坐下去 → 重心降低 → 更稳定
  * 横向方向：膝盖向外推 → 像膝盖要碰到雪面外侧 → 产生刃角 → 转弯力量来源
- 力学原理：膝盖外开 → 小腿向板边倾斜 → 雪板立起刃角 → 刃咬住雪；膝盖下压 → 垂直压力增加 → 刃切入雪面更深 → 抓地力增强
- 检查方法：从正面看，膝盖应该超出脚尖外侧，不是在脚尖内侧！从侧面看，前膝明显比后膝弯得更深，像弓步
- 感受指标：大腿外侧（髂胫束）像拉紧的绳子，持续紧绷；大腿前侧（股四头肌）持续发力，像深蹲的感觉；能感觉板刃像刀一样"咬住"雪面，有明确的抓地感
- 常见错误分析：膝盖向内夹 → 像关门而不是开门 → 刃角消失 → 雪板平躺在雪面 → 像溜冰打滑

**髋部（屈曲、旋转与角化）**：
- 观察：髋部是否像旋转门一样灵活转动？同时保持适当的前倾？
- 姿态比喻：屈曲像要坐在高脚凳上，屁股向后撅；旋转像转身看后面的人，髋部先转；角化：髋部向弯内移动，但不要倒下去
- 原理：髋部是单板控制的指挥中心，三个维度的运动缺一不可
- 运动链：髋部旋转 → 像传动轴一样带动大腿 → 雪板跟着转 → 膝盖角化产生刃角
- 感受指标：屈曲时髋屈肌（腹股沟）有拉伸感；旋转时髋部在前脚正上方，不是在两脚中间；角化时能感觉髋部向弯内推，但头还在雪板上方
- 常见错误：髋部不旋转 → 像机器人转身 → 只靠肩膀转 → 上下身打架 → 失控

### 2. 上半身姿态与扭转

**躯干前倾与侧倾（双平面姿态）**：
- 观察：鼻子是否在前脚绑定上方？身体有没有像树一样倒向弯内侧？
- 姿态比喻：前倾像要闻前脚的气味；侧倾像在抵抗侧风，但不要倒下去
- 原理：前倾质心前移 → 前脚承重 → 板头听你指挥；侧倾配合下肢角化 → 增加一点刃角 → 但主要靠膝盖，不是靠躯干倒
- 关键：前倾是主角，侧倾是配角（千万别本末倒置！）
- 感受指标：前倾时感觉前脚掌承担主要重量；侧倾时头部还在雪板上方，没有伸到板外侧去
- 常见错误：过度侧倾 → 像树倒了 → 质心跑到支撑面外 → 直接摔倒

**肩膀旋转（上身扭转控制）**：
- 观察：前手是否指向下一个转弯的出口？肩膀比髋部转得少？
- 姿态比喻：像拧毛巾 —— 肩膀和髋部反向拧紧，然后释放
- 理想状态：肩膀朝向下一个转弯出口，髋部还在完成上一个转弯
- 原理：上下身反向扭转储存弹性能量，就像压缩弹簧，释放时转弯爆发力强
- 运动链：肩膀先转向出口 → 躯干扭转 → 像拧紧发条；髋部跟随旋转 → 释放扭转能量 → 雪板快速转向
- 感受指标：能感觉到腰腹部有扭转张力；后肩能看到后手，说明扭转充分
- 常见错误：肩髋同步转 → 没有扭转 → 没有预加载 → 转弯慢吞吞

**手臂位置（平衡与方向指示）**：
- 观察：前手是否像指路牌一样指向你要去的地方？后手打开帮助平衡？
- 姿态比喻：前手像指挥棒，指哪打哪；后手像飞机机翼，打开保持平衡
- 原理：前手指向：眼睛跟随手指 → 肩膀跟随视线 → 全身协调转向；双臂打开：增加旋转惯量 → 像花样滑冰张开手臂 → 上身更稳定
- 感受指标：前手始终指向你想去的方向，像车灯照向前方
- 常见错误：双手下垂或贴身 → 像企鹅 → 失去平衡功能 → 容易被颠簸扰动

### 3. 雪板工作状态（结果验证）

**刃角（Edge Angle）**：
- 观察：能否看到整块板底？看到的面积越大说明刃角越大
- 视觉比喻：像用刀切西瓜 —— 刀立得越直（刃角越大），切得越深
- 原理：单板单刃承重，需要更大刃角才能产生足够的向心力不被甩出去
- 验证方法：刃角够大的话，能看到大部分板底；应该听到尖锐的"呲呲"切雪声，不是"沙沙"侧滑声；雪花从板刃一侧高速喷出，形成漂亮的"公鸡尾"

**压力分布（前后脚配重）**：
- 观察：雪印前段是否明显更深？
- 理想比喻：前脚像船长掌舵，后脚像水手辅助
- 原理：前脚主导控制板头方向，后脚稳定板尾防止甩尾
- 动态变化：转弯启动时前脚压得更重 → 板头快速切入弯内 → 像船头劈波斩浪
- 感受指标：前脚掌持续有明显压力感，像踩油门
- 验证方法：雪印前段深，后段浅；转弯启动干脆利落，不拖泥带水

**板头板尾独立控制**：
- 观察：能否感觉到前后脚独立发力？不是一起用力？
- 原理：单板虽然是一整块板，但通过压力分配实现"虚拟分段"
- 比喻：板头控制：前脚下压 → 像踩跷跷板的一端 → 板头插入雪面 → 启动转弯；板尾控制：后脚下压 → 稳定后端 → 完成转弯不甩尾
- 感受指标：能清楚感觉到前后脚分工明确，不是同时均匀用力
`;

  const analysisGuide = sport === 'skiing' ? skiingAnalysisGuide : snowboardingAnalysisGuide;
  
  const prompt = `【分析任务】

你正在分析${framework}下的第 ${segmentNumber}/${totalSegments} 个动作片段。

【地形】${terrainMap[terrain] || terrain} - ${terrainContext}

【分析要求】

${analysisGuide}

### 4. 运动链完整性检查（必须分析）

**动作序列的因果关系**：
- 从下到上：脚踝启动 → 膝盖跟随 → 髋部协调 → 躯干稳定 → 肩膀指引
- 从上到下：肩膀指向目标 → 髋部旋转跟随 → 膝盖角化执行 → 脚踝传递力量
- 原理：运动是运动链协同工作的结果，像传送带一样环环相扣，不是某个关节单打独斗
- 比喻：就像推倒多米诺骨牌，一个动作触发下一个，形成流畅的连锁反应
- 检查：如果某个环节有问题，往往是上游环节没做对导致的

**力量传递路径**：
- 重力路径：你的体重 → 通过脚踝传到雪板 → 雪板压雪面 → 雪面反推你 → 产生向心力
- 主动发力：肌肉收缩 → 改变关节角度 → 雪板姿态变化 → 滑行轨迹改变
- 比喻：力量像水流，要沿着最优路径流动，不能在中间"漏水"或"堵塞"
- 检查：力量有没有在某个关节"泄掉"？比如膝盖内夹就是力量泄漏

**时机与节奏**：
- 动作启动时机：是不是该转弯时才开始转？还是提前或滞后了？
- 关节配合节奏：各个关节是否按正确顺序依次启动？还是同时僵硬地一起动？
- 比喻：像乐队演奏，每个乐器要在正确的节拍上加入，太早太晚都不和谐
- 检查：转弯启动是否在合适的时机？动作是否流畅如行云流水？

---

## 分析输出要求

### 标题格式（5-7 个汉字）

直接指出关键问题或核心动作，必须具体到：
- 关节名称 + 问题：例如 "膝盖向内夹" "髋部不旋转" "脚踝太僵"
- 动作方向 + 问题：例如 "重心太靠后" "肩膀逆转" "前倾不足"
- ❌ 避免："姿势问题" "需要改进" "动作不对" "还可以"

### 分析内容（5句话强制结构）

**第一句 - 问题识别（观察层面）**：
- 格式：[关节/部位] + [具体偏差] + [生动比喻]
- 必须包含：可观察的具体描述和形象比喻
- ✅ 例如："你的膝盖向内夹紧，像X型腿一样，而不是像骑马那样向外打开"
- ❌ 避免："你的膝盖有点问题" "姿势需要调整"

**第二句 - 生物力学原理（为什么这是问题）**：
- 格式：[错误动作] → [力学链条断裂] → [技术后果]
- 必须说明力的传递路径如何被破坏，使用生动比喻
- ✅ 例如："膝盖内夹就像关门而不是开门，导致小腿无法向外倾斜，力量传不到雪板外刃，刃角从应有的立起来变成平躺在雪面，失去抓地力像溜冰打滑"
- ❌ 避免："这样会导致滑不好" "影响转弯效果"

**第三句 - 具体改进方法（可操作指令）**：
- 格式：[准备动作] + [执行动作] + [生动比喻]
- 必须可以立即尝试，包含形象化的身体感受
- ✅ 例如："转弯前，想象用膝盖向外推开一扇沉重的门，感觉大腿外侧像拉紧的绳子持续绷紧，同时膝盖向下压，像要坐在隐形的高脚凳上"
- ❌ 避免："试着改进一下膝盖" "注意膝盖动作" "保持正确姿势"

**第四句 - 验证方法（感官反馈）**：
- 格式：[触觉反馈] + [视觉反馈] + [听觉反馈]
- 让学习者知道如何通过感官确认自己做对了
- ✅ 例如："做对时你会感觉大腿外侧像拉紧的橡皮筋持续紧绷，看到雪板像刀刃一样立起来切入雪面，听到板刃切雪的清脆'呲呲'声"
- ❌ 避免："做对了就会好很多" "效果会明显改善"

**第五句 - 简短鼓励（1句话）**：
- 指出做得好的地方 + 简短鼓励
- ✅ 例如："你的上半身稳定性很好，配合膝盖外开就完美了！"
- ❌ 避免："你一定可以的！继续加油！相信自己！"（空洞鼓励）

请以JSON格式返回：
{
  "title": "标题（5-7个汉字）",
  "text": "第一句问题识别。第二句生物力学原理。第三句具体改进方法。第四句验证方法。第五句简短鼓励。"
}`;

  for (let i = 0; i < retries; i++) {
    try {
      const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });
      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();
      
      // 尝试解析JSON（可能包含markdown代码块）
      let jsonText = text.trim();
      if (jsonText.startsWith('```json')) {
        jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      } else if (jsonText.startsWith('```')) {
        jsonText = jsonText.replace(/```\n?/g, '').trim();
      }
      
      const coaching = JSON.parse(jsonText);
      return coaching;
    } catch (error) {
      console.error(`Gemini API 调用失败 (尝试 ${i + 1}/${retries}):`, error.message);
      if (i === retries - 1) {
        // 最后一次失败，返回默认反馈
        return {
          title: `片段 ${segmentNumber} 分析`,
          text: `这是第${segmentNumber}个视频片段。由于AI分析暂时不可用，请继续观看视频，注意保持平衡和正确的姿势。`
        };
      }
      // 等待后重试
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}

// 生成练习推荐
async function generateRecommendations(sport, terrain, allSegments, retries = 3) {
  const framework = sport === 'skiing' ? 'CSIA' : 'CASI';
  const sportName = sport === 'skiing' ? '双板滑雪' : '单板滑雪';
  
  const terrainMap = {
    'beginner': '平地/绿道（初级）',
    'intermediate': '蓝道（中级）',
    'advanced': '黑道（高级陡坡）',
    'moguls': '蘑菇道（雪包）',
    'freestyle': '自由式（公园、跳台）'
  };

  // 提取所有反馈中的主要问题
  const identifiedIssues = [];
  allSegments.forEach(segment => {
    if (segment.coaching && segment.coaching.text) {
      // 从反馈文本中提取关键问题（简单提取，实际可以更智能）
      const text = segment.coaching.text;
      // 提取包含"问题"、"错误"、"不足"等关键词的句子
      const sentences = text.split(/[。！？]/);
      sentences.forEach(sentence => {
        if (sentence.includes('问题') || sentence.includes('错误') || sentence.includes('不足') || 
            sentence.includes('内夹') || sentence.includes('僵直') || sentence.includes('后仰') ||
            sentence.includes('不旋转') || sentence.includes('过度')) {
          const issue = sentence.trim();
          if (issue && !identifiedIssues.includes(issue)) {
            identifiedIssues.push(issue);
          }
        }
      });
    }
  });

  // 如果没有提取到问题，使用默认问题
  if (identifiedIssues.length === 0) {
    identifiedIssues.push('需要改进基本姿势和平衡');
  }
  
  const prompt = `【任务】

根据刚才的 ${allSegments.length} 个动作片段分析，生成 3-4 个专项练习。

【识别的主要问题】

${identifiedIssues.join('\n')}

【练习设计要求】

1. **针对性**：每个练习必须针对上述具体问题之一

2. **渐进性**：从简单到复杂排序

3. **可测量**：练习目标必须可量化（次数、时间、角度）

【每个练习的结构】

{
  "name": "英文名称 (中文名称)",
  "description": "2-3句话说明练习方法和目标",
  "keyPoints": ["关键点1（必须包含具体数值或感官反馈）", "关键点2"]
}

【地形】${terrainMap[terrain] || terrain}

【教学框架】${framework}

请以JSON格式返回：
{
  "recommendations": [
    {
      "name": "练习名称（中英文）",
      "description": "练习描述",
      "keyPoints": ["要点1（包含具体数值）", "要点2（包含具体数值）"]
    }
  ]
}`;

  for (let i = 0; i < retries; i++) {
    try {
      const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });
      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();
      
      // 尝试解析JSON
      let jsonText = text.trim();
      if (jsonText.startsWith('```json')) {
        jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      } else if (jsonText.startsWith('```')) {
        jsonText = jsonText.replace(/```\n?/g, '').trim();
      }
      
      const data = JSON.parse(jsonText);
      return data;
    } catch (error) {
      console.error(`生成练习推荐失败 (尝试 ${i + 1}/${retries}):`, error.message);
      if (i === retries - 1) {
        // 返回默认推荐
        return {
          recommendations: [
            {
              name: '基础平衡练习 (Basic Balance)',
              description: '在平地上练习保持平衡，这是所有技术的基础。',
              keyPoints: ['保持身体中心', '放松膝盖', '目视前方']
            }
          ]
        };
      }
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}

// API 端点：上传视频
app.post('/api/upload', upload.single('video'), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: '未上传视频文件' });
    }

    const { sport, terrain } = req.body;
    if (!sport || !terrain) {
      return res.status(400).json({ error: '缺少运动类型或地形信息' });
    }

    const videoPath = req.file.path;
    const videoId = path.basename(req.file.filename, path.extname(req.file.filename));
    const videoUrl = `/uploads/${req.file.filename}`;

    // 获取视频元数据
    const metadata = await getVideoMetadata(videoPath);
    
    // 检测运动变化点（分割为5个片段）
    const segments = detectMotionChanges(metadata.duration, 5);

    // 为每个片段生成AI反馈
    const segmentsWithCoaching = await Promise.all(
      segments.map(async (segment) => {
        const coaching = await generateCoachingFeedback(
          sport,
          terrain,
          segment.id,
          segments.length
        );
        return {
          ...segment,
          coaching
        };
      })
    );

    res.json({
      success: true,
      videoId: videoId,
      videoUrl: videoUrl,
      segments: segmentsWithCoaching
    });
  } catch (error) {
    console.error('上传处理错误:', error);
    res.status(500).json({ error: '视频处理失败: ' + error.message });
  }
});

// API 端点：获取练习推荐
app.get('/api/video/:videoId/recommendations', async (req, res) => {
  try {
    const { videoId } = req.params;
    const { sport, terrain, segments } = req.query;

    if (!sport || !terrain) {
      return res.status(400).json({ error: '缺少运动类型或地形信息' });
    }

    // 解析 segments 数据（从前端传递）
    let allSegments = [];
    if (segments) {
      try {
        allSegments = JSON.parse(decodeURIComponent(segments));
      } catch (e) {
        console.error('解析 segments 失败:', e);
      }
    }

    const recommendations = await generateRecommendations(sport, terrain, allSegments);
    res.json(recommendations);
  } catch (error) {
    console.error('生成推荐错误:', error);
    res.status(500).json({ error: '生成推荐失败: ' + error.message });
  }
});

// 健康检查
app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

// 启动服务器
app.listen(PORT, () => {
  console.log(`服务器运行在端口 ${PORT}`);
  console.log(`环境: ${process.env.NODE_ENV || 'development'}`);
});

